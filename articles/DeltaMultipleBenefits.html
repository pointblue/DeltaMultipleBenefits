<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>DeltaMultipleBenefits • DeltaMultipleBenefits</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="DeltaMultipleBenefits">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DeltaMultipleBenefits</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/DeltaMultipleBenefits.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/tidal_wetland_restoration.html">Tidal wetland restoration</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pointblue/DeltaMultipleBenefits/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>DeltaMultipleBenefits</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pointblue/DeltaMultipleBenefits/blob/main/vignettes/DeltaMultipleBenefits.Rmd" class="external-link"><code>vignettes/DeltaMultipleBenefits.Rmd</code></a></small>
      <div class="d-none name"><code>DeltaMultipleBenefits.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The DeltaMultipleBenefits package facilitates estimating the net
impacts of scenarios of landscape change in the Sacramento-San Joaquin
River Delta, created with funding from the Proposition 1 Delta Water
Quality and Ecosystem Restoration Program administered by the California
Department of Fish and Wildlife (Grant Agreement Number–Q1996022).</p>
<p>The package provides tools for applying existing data and species
distribution models to user-supplied landscapes to estimate a range of
benefits to the Delta community and how they compare to other
landscapes. Currently, the benefit categories addressed include:
Agricultural Livelihoods, Water Quality, Climate Change Resilience, and
Biodiversity Support. Each category is represented by multiple
individual metrics that can be summarized over the entire landscape. By
comparing metrics estimated from proposed scenarios of landscape change
to metrics estimated for a baseline landscape representing current
conditions, the expected net change in each metric can be estimated.</p>
<p>Ultimately, this R package is intended to facilitate a more
comprehensive multidimensional understanding of the direction and
magnitude of the potential impacts of landscape change (proposed or
anticipated), communication about the projected synergies and trade-offs
among multiple goals, and the identification of solutions to address
these trade-offs.</p>
<p>This vignette serves as a tutorial outlining the major steps of
analyzing alternative Delta landscapes and comparing them to each other,
including:</p>
<ol style="list-style-type: decimal">
<li>Preparing new landscape scenarios for analysis</li>
<li>Summarizing the net change in the total area of each land cover
class</li>
<li>Estimating the net change in simple metrics<br>
</li>
<li>Estimating the net change in metrics informed by spatial models</li>
</ol>
<p>Here, we use a toy land cover data set as an example of how to work
through these steps, but to reproduce the analyses conducted in Dybala
et al. (In review)<a href="https://doi.org" class="external-link">doi:Link TBD</a>, the
original baseline land cover data, scenarios, distribution models, and
other required supporting data can be accessed online (see “Supporting
Data” below) or are included with this package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pointblue/DeltaMultipleBenefits" class="external-link">DeltaMultipleBenefits</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.8.42</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, union</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     extract</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'magrittr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:tidyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     extract</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     extract, inset</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-1--preparing-a-new-landscape-scenario-for-analysis">Step 1. Preparing a new landscape scenario for analysis<a class="anchor" aria-label="anchor" href="#step-1--preparing-a-new-landscape-scenario-for-analysis"></a>
</h2>
<p>To prepare a new landscape scenario for analysis with the
<em>DeltaMultipleBenefits</em> framework, its land cover classifications
must first be aligned with those used in the framework, which are
designed to work with the existing metrics and species distribution
models. This land cover classification scheme includes both natural and
agricultural land cover classes, and is organized hierarchically into
major land cover classes and subclasses. Certain subclasses are only
relevant to certain metrics and species distribution models, while other
metrics will apply to the entire major land cover class. Therefore, we
generally recommend assigning all land covers in your landscape scenario
to the most specific subclass in the existing scheme:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">key</span>, package <span class="op">=</span> <span class="st">'DeltaMultipleBenefits'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">key</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   CODE_BASELINE CODE_NAME                  CLASS     SUBCLASS DETAIL LABEL COLOR</span></span>
<span><span class="co">#&gt;           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>            10 PERENNIAL_CROPS            PERENNIA… <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>     Pere… #940…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>            11 ORCHARD_DECIDUOUS          <span style="color: #BB0000;">NA</span>        DECIDUO… <span style="color: #BB0000;">NA</span>     Orch… #940…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>            15 ORCHARD_CITRUS&amp;SUBTROPICAL <span style="color: #BB0000;">NA</span>        CITRUS … <span style="color: #BB0000;">NA</span>     Orch… #C76…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>            19 VINEYARD                   <span style="color: #BB0000;">NA</span>        VINEYARD <span style="color: #BB0000;">NA</span>     Vine… #ECB…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>            20 ANNUAL_CROPS               ANNUAL C… <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>     Annu… #32C…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>            21 GRAIN&amp;HAY                  <span style="color: #BB0000;">NA</span>        GRAIN &amp;… <span style="color: #BB0000;">NA</span>     Grai… #FFA…</span></span></code></pre></div>
<div class="section level3">
<h3 id="working-with-polygons">1.1 Working with polygons<a class="anchor" aria-label="anchor" href="#working-with-polygons"></a>
</h3>
<p>As an example of how to align the land cover classifications for a
new landscape scenario represented by polygons, we’ll work with the
<code>olinda1</code> dataset from a file contained in the
<code>sf</code> package. This data set includes place names instead of
land cover classifications, but we’ll treat them as though they
represented land covers and recode them to supported
<code>CODE_NAME</code> values in the <code>key</code>. Finally, we’ll
join the <code>key</code> data to match new <code>CODE_NAME</code>
values to <code>CODE_BASELINE</code> values we’ll need later on.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">olinda1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shape/olinda1.shp"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span>, </span>
<span>                       quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">olinda1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -34.86406 ymin: -7.999297 xmax: -34.85496 ymax: -7.988471</span></span>
<span><span class="co">#&gt; Geodetic CRS:  GRS 1980(IUGG, 1980)</span></span>
<span><span class="co">#&gt;      ID      CD_GEOCODI   TIPO   CD_GEOCODB    NM_BAIR V014</span></span>
<span><span class="co">#&gt; 1 28801 260960005000001 URBANO 260960005020 Ouro Preto 1119</span></span>
<span><span class="co">#&gt; 2 28802 260960005000002 URBANO 260960005020 Ouro Preto 1267</span></span>
<span><span class="co">#&gt; 3 28803 260960005000003 URBANO 260960005020 Ouro Preto  557</span></span>
<span><span class="co">#&gt; 4 28804 260960005000004 URBANO 260960005020 Ouro Preto  709</span></span>
<span><span class="co">#&gt; 5 28805 260960005000005 URBANO 260960005020 Ouro Preto 1045</span></span>
<span><span class="co">#&gt; 6 28806 260960005000006 URBANO 260960005020 Ouro Preto  727</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 POLYGON ((-34.86406 -7.9924...</span></span>
<span><span class="co">#&gt; 2 POLYGON ((-34.86129 -7.9899...</span></span>
<span><span class="co">#&gt; 3 POLYGON ((-34.85856 -7.9924...</span></span>
<span><span class="co">#&gt; 4 POLYGON ((-34.85752 -7.9948...</span></span>
<span><span class="co">#&gt; 5 POLYGON ((-34.8582 -7.99754...</span></span>
<span><span class="co">#&gt; 6 POLYGON ((-34.85957 -7.9960...</span></span>
<span></span>
<span><span class="va">new_shp</span> <span class="op">&lt;-</span> <span class="va">olinda1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># recode existing place name values with supported land cover names in key</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    CODE_NAME <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Ouro Preto'</span>, <span class="st">'Sítio Novo'</span>, <span class="st">'Sapucaia'</span>, <span class="st">'Salgadinho'</span><span class="op">)</span> <span class="op">~</span></span>
<span>        <span class="st">'ORCHARD_DECIDUOUS'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Tabajara'</span>, <span class="st">"Caixa D'Água"</span>, <span class="st">'Águas Compridas'</span>, </span>
<span>                     <span class="st">'São Benedito'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'ORCHARD_CITRUS&amp;SUBTROPICAL'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Fragoso'</span>, <span class="st">'Alto da Bondade'</span>, <span class="st">'Alto da Conquista'</span>, </span>
<span>                     <span class="st">'Passarinho'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'VINEYARD'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Bultrins'</span>, <span class="st">'Jardim Atlântico'</span>, <span class="st">'Rio Doce'</span>, </span>
<span>                     <span class="st">'Alto do Sol Nascente'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'GRAIN&amp;HAY_WHEAT'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Alto da Nação'</span>, <span class="st">'Monte'</span>, <span class="st">'Casa Caiada'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'FIELD_CORN'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Guadalupe'</span>, <span class="st">'Bonsucesso'</span>, <span class="st">'Bairro Novo'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'RIPARIAN_FOREST_POFR'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Varadouro'</span>, <span class="st">'Amparo'</span>, <span class="st">'Amaro Branco'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'RIPARIAN_FOREST_QULO'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Vila Popular'</span>, <span class="st">'Peixinhos'</span>, <span class="st">'Carmo'</span><span class="op">)</span> <span class="op">~</span></span>
<span>        <span class="st">'WETLAND_MANAGED_PERENNIAL'</span>,</span>
<span>      <span class="va">NM_BAIR</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Jardim Brasil'</span>, <span class="st">'Aguazinha'</span>, <span class="st">'Santa Teresa'</span><span class="op">)</span> <span class="op">~</span> </span>
<span>        <span class="st">'WETLAND_MANAGED_SEASONAL'</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">NM_BAIR</span><span class="op">)</span> <span class="op">~</span> <span class="st">'PASTURE_ALFALFA'</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">'UNKNOWN'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># transfer CODE_BASELINE values from key</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">key</span>, by <span class="op">=</span> <span class="st">'CODE_NAME'</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">new_shp</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">CODE_NAME</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="DeltaMultipleBenefits_files/figure-html/classify_poly-1.png" width="672"></p>
<p>Next, convert the polygons to a raster format with the desired
projection, extent, and resolution. Simple features objects must first
be converted to SpatVector objects using <code><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">terra::vect()</a></code>.
Then we’ll create a raster template with a small number of columns and
rows (and thus coarse resolution) just for demonstration purposes, but
to ensure alignment with other rasters in your analysis, it usually
works best to use an existing raster as a template. Next, transfer the
land cover code values to the template to create a new landscape raster
that we’ll treat as our “baseline” landscape. Finally, to help with
plotting, we’ll assign factor levels and color codings.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simplify number of fields, change to SpatVector, and change projection</span></span>
<span><span class="va">new_vect</span> <span class="op">=</span> <span class="va">new_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CODE_NAME</span>, <span class="va">CODE_BASELINE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">template</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">new_vect</span>, ncols <span class="op">=</span> <span class="fl">100</span>, nrows <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baseline</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">new_vect</span>,</span>
<span>                            y <span class="op">=</span> <span class="va">template</span>, </span>
<span>                            field <span class="op">=</span> <span class="st">'CODE_BASELINE'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assign factor levels:</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/factors.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">baseline</span><span class="op">)</span> <span class="op">&lt;-</span>  <span class="va">key</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">CODE_BASELINE</span>, label <span class="op">=</span> <span class="va">CODE_NAME</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assign color coding</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/colors.html" class="external-link">coltab</a></span><span class="op">(</span><span class="va">baseline</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">key</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CODE_BASELINE</span>, <span class="va">COLOR</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html" class="external-link">complete</a></span><span class="op">(</span>CODE_BASELINE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">255</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">COLOR</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">baseline</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="working-with-existing-rasters">1.2 Working with existing rasters<a class="anchor" aria-label="anchor" href="#working-with-existing-rasters"></a>
</h3>
<p>If the landscape to be analyzed is in a raster format already, the
existing land cover values encoded should be similarly translated to the
supported values in the existing land cover classification scheme. As an
example, we’ll use <code>baseline</code> raster we created above, and
create a new version from it to serve as our new <code>scenario</code>
of landscape change.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simple example scenario: all wheat pixels (22) are converted to Fremont </span></span>
<span><span class="co"># cottonwood riparian forest (71)</span></span>
<span><span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html" class="external-link">classify</a></span><span class="op">(</span><span class="va">baseline</span>,</span>
<span>                            rcl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">22</span>, to <span class="op">=</span> <span class="fl">71</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                              <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/factors.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">&lt;-</span>  <span class="va">key</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">CODE_BASELINE</span>, label <span class="op">=</span> <span class="va">CODE_NAME</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/colors.html" class="external-link">coltab</a></span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">key</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CODE_BASELINE</span>, <span class="va">COLOR</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html" class="external-link">complete</a></span><span class="op">(</span>CODE_BASELINE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">255</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">COLOR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># stack landscapes to compare</span></span>
<span><span class="va">landscapes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">baseline</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'baseline'</span>, <span class="st">'scenario'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span> <span class="co">#Note the orange wheat cells have changed to red riparian cells</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="step-2--summarizing-the-net-change-in-the-total-area-of-each-land-cover-class">Step 2. Summarizing the net change in the total area of each land
cover class<a class="anchor" aria-label="anchor" href="#step-2--summarizing-the-net-change-in-the-total-area-of-each-land-cover-class"></a>
</h2>
<p>Built-in functions make it simple to estimate the change in the total
area of each land cover class between the baseline and one or more
scenario landscape rasters. First, sum the total area of each land cover
class in each landscape raster, then summarize the change between
them.</p>
<p><strong>sum_landcover:</strong> This function takes a SpatRaster with
one or more layers and, for each layer, counts the number of pixels of
each unique land cover class and multiplies by the provided
<code>pixel_area</code> value to estimate the total area of each land
cover class. It returns a tibble with the scenario name (taken from the
names of each raster layer), the <code>CODE_NAME</code> of each land
cover class, and the total area. Here we’ll first use
<code><a href="https://rspatial.github.io/terra/reference/cellSize.html" class="external-link">terra::cellSize</a></code> to estimate the area of each pixel in ha.
The option <code>rollup = TRUE</code> adds extra rows to the output with
the sum total area for all riparian and managed wetland subclasses. This
function also supports options to mask out portions of the raster and/or
to summarize the total area by zone.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">area</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/cellSize.html" class="external-link">cellSize</a></span><span class="op">(</span><span class="va">baseline</span>, unit <span class="op">=</span> <span class="st">'ha'</span><span class="op">)</span><span class="op">[</span><span class="fl">50</span>,<span class="fl">50</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">deframe</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">landcover_totals</span> <span class="op">=</span> <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/sum_landcover.html">sum_landcover</a></span><span class="op">(</span></span>
<span>  landscapes <span class="op">=</span> <span class="va">landscapes</span>, </span>
<span>  pixel_area <span class="op">=</span> <span class="va">area</span>,</span>
<span>  rollup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">scenario</span>, <span class="va">CODE_NAME</span><span class="op">)</span></span></code></pre></div>
<p><strong>sum_change:</strong> This function calculates the net change
in the area of each land cover class between the baseline landscape and
one or more scenario landscapes. Note that this function expects the
output from <code>sum_landcover</code>, which includes the field
<code>scenario</code> representing the names of each landscape. At least
one scenario must be named “baseline”, and all other scenarios will be
assumed to represent an alternative scenario landscape for comparison to
the baseline. Thus the net change for multiple scenarios can be
estimated simultaneously. The result is a tibble with the scenario name,
the <code>CODE_NAME</code> of each land cover class, fields representing
the total area of the land cover class for the scenario in question and
the corresponding area for the baseline, and then the
<code>net_change</code> between them, where a positive value indicates
an increase from the baseline.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landcover_change</span> <span class="op">=</span> <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/sum_change.html">sum_change</a></span><span class="op">(</span><span class="va">landcover_totals</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-3--estimating-the-net-change-in-simple-metrics">Step 3. Estimating the net change in simple metrics<a class="anchor" aria-label="anchor" href="#step-3--estimating-the-net-change-in-simple-metrics"></a>
</h2>
<p>We developed several “simple metrics” representing several categories
of benefits including: <em>agricultural livelihoods</em>, <em>water
quality</em>, and <em>climate change resilience</em>. For example,
agricultural livelihood metrics include the number of agricultural jobs,
their average annual wage, and gross production value. These are all
“simple metrics” in the sense that a single mean value for each metric
is used to represent each land cover class, regardless of where in the
Delta the land cover is located. Therefore, estimating the net change in
these metrics between a baseline and scenario landscape is relatively
simple compared to estimating the net change in metrics derived from a
spatial model (see below), and the steps are similar to estimating the
net change in land cover area above. However, the uncertainty in the
value of each metric for each land cover class, such as resulting from
spatial or temporal variation, can also be accounted for in estimating
the uncertainty in the net change. The values assigned to each land
cover class for each metric are available to download via Zenodo (<a href="doi:%5B10.5281/zenodo.7504874" class="uri">doi:[10.5281/zenodo.7504874</a>](<a href="https://doi.org/10.5281/zenodo.7504874" class="external-link uri">https://doi.org/10.5281/zenodo.7504874</a>)), but are also
included in this package:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">metrics</span>, package <span class="op">=</span> <span class="st">'DeltaMultipleBenefits'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">metrics</span><span class="op">)</span></span></code></pre></div>
<p><strong>sum_metrics:</strong> First estimate the total landscape
score for each metric and landscape raster, by combining total area of
each land cover class estimated above with the per-unit-area metrics for
each land cover class. For most metrics, this involves multiplying the
per-unit-area metrics by the total area of each land cover class and
summing over the entire landscape. For Annual Wages (as part of the
Agricultural Livelihoods category of benefits), it instead calculates
the new weighted average wage across all agricultural hectares (i.e.,
those supporting agricultural jobs with an associated wage value). For
metrics in the Climate Change Resilience category, it instead calculates
the new overall average resilience score on a scale of 1 (low
resilience) to 10 (high resilience). The function returns a tibble with
the scenario name, fields from <code>metrics</code> defining metric
categories and units, a <code>SCORE_TOTAL</code> and a
<code>SCORE_TOTAL_SE</code>, representing the combined uncertainty. The
<code>units</code> field is also updated to reflect that the scores are
no longer per-hectare, but instead summed over all hectares in the
landscape.</p>
<p>The total area of each land cover class as calculated above includes
both the area of individual riparian and managed wetland subclasses as
well as the roll-up total area, so we must take care not to double-count
them in the total landscape scores calcualted here. Thus far,
<code>metrics</code> are not available for riparian and managed wetland
subclasses, and instead apply to riparian and managed wetland land
covers generally. Therefore, here we filter out the subclasses to
exclude them from this calculation.</p>
<p><em>Note: We will get a warning message here, because our example
landscapes do not include all land cover classes present in our metrics
data.</em></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scores</span> <span class="op">=</span> <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/sum_metrics.html">sum_metrics</a></span><span class="op">(</span></span>
<span>  metricdat <span class="op">=</span> <span class="va">metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'RIPARIAN_|WETLAND_MANAGED_|WETLAND_TIDAL|WATER'</span>, <span class="va">CODE_NAME</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  areadat <span class="op">=</span> <span class="va">landcover_totals</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'RIPARIAN_|WETLAND_MANAGED_|WETLAND_TIDAL|WATER'</span>, <span class="va">CODE_NAME</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p><strong>sum_change:</strong> Then, we can again use
<code>sum_change</code> to estimate the difference in each metric
between the baseline and scenario landscapes. However, this time because
there is uncertainty in the total landscape scores, the uncertainty in
the difference will also be estimated. Here we use a coverage factor
<code>k = 2</code> to approximate a 95% confidence interval for the
<code>net_change</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scores_change</span> <span class="op">=</span> <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/sum_change.html">sum_change</a></span><span class="op">(</span><span class="va">scores</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">scores_change</span><span class="op">)</span></span></code></pre></div>
<p>Visualize the resulting estimates of net change:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scores_change</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># invert water quality scores so a reduction in pesticide use is shown as a</span></span>
<span>  <span class="co"># net benefit</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    net_change <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">METRIC_CATEGORY</span> <span class="op">==</span> <span class="st">'Water Quality'</span>,</span>
<span>      <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="va">net_change</span>,</span>
<span>      <span class="va">net_change</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">net_change</span>, <span class="va">METRIC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">METRIC_CATEGORY</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">lcl</span>, xmax <span class="op">=</span> <span class="va">ucl</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add blank geoms to ensure zeroes line up across facets</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_blank.html" class="external-link">geom_blank</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="va">ucl</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_blank.html" class="external-link">geom_blank</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="va">lcl</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-4--estimating-the-net-change-in-metrics-informed-by-spatial-models">Step 4. Estimating the net change in metrics informed by spatial
models<a class="anchor" aria-label="anchor" href="#step-4--estimating-the-net-change-in-metrics-informed-by-spatial-models"></a>
</h2>
<p>In addition to the “simple metrics” described above, we developed
spatial distribution models for riparian landbirds and waterbirds that
predict the probability of species presence for each pixel on the
landscape, depending on the land cover class at that pixel, the
composition of land cover classes in the surrounding area, and other
features of the landscape. We used the probability of presence
predictions as an indicator of suitable habitat, and to represent the
benefits category of <em>biodiversity support</em>. Evaluating the net
change in biodiversity support between scenario and baseline landscapes
is necessarily more complicated than evaluating the “simple metrics”
above, but also allows for more nuance and spatial variation.</p>
<p>Currently, the only spatial models supported are the distribution
models for riparian landbird species and groups of waterbird species.
Their development is described in a manuscript (<a href="https://doi.org" class="external-link">Dybala et al. In review - Link TBD</a>) and the
models are available to download via Zenodo (doi: <a href="https://doi.org/10.5281/zenodo.7531945" class="external-link">10.5281/zenodo.7531945</a>).
However, spatial models for other species, and for other benefits
categories could be incorporated in future versions of this package as
they are developed.</p>
<div class="section level3">
<h3 id="riparian-landbird-models">4.1 Riparian landbird models<a class="anchor" aria-label="anchor" href="#riparian-landbird-models"></a>
</h3>
<div class="section level4">
<h4 id="prepare-landscape-predictors">4.1.1 Prepare landscape predictors<a class="anchor" aria-label="anchor" href="#prepare-landscape-predictors"></a>
</h4>
<p>Beginning with the models for riparian landbird species, first use
built-in functions to generate focal statistics for each pixel in the
baseline and scenario landscape rasters that represent features of the
landscape within a certain distance of each survey location. The steps
are to: (1) prepare each landscape raster for generating focal stats,
(2) use Python to run the focal stats, and (3) finalize the predictors
for use with the models. For ease of use with a large number of rasters,
each of these functions are intended to write to or read from a
directory defined in the functions arguments, rather than work with
rasters in memory.</p>
<p><strong>python_focal_prep:</strong> The first step separates each
landscape raster into separate layers for each distinct land cover
class, with a default value of <code>1</code> everywhere the land cover
class is present, and a <code>0</code> otherwise. In addition, this
function calls the function <code>reclassify_landcover</code> to
aggregate and rename the land cover classes as appropriate for the
intended set of distribution models, specified by the value of
<code>SDM</code>. Currently, the only options for <code>SDM</code>
include ‘riparian’, ‘waterbird_fall’, or ‘waterbird_win’. The result is
written to a directory located at:
<code>pathout/SDM/landscape_name</code>. If the directory does not
already exist, it will be created automatically.</p>
<p><em>Note: the function will expect the values in each provided
landscape to have labels assigned, for use in defining the names of the
new layers.</em></p>
<p>Use the <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map</a></code> function to run this function for
each landscape:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/python_focal_prep.html">python_focal_prep</a></span><span class="op">(</span></span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'riparian'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'GIS/SDM_predictors/cover'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>python_focal_run:</strong> The second step is to generate
focal statistics for each of the separate land cover rasters generated
in the previous step. Focal statistics perform a given operation on all
cells within a given distance of the focal cell, and repeated for every
cell in the raster. This process is slow, and while it can be run
entirely in R, it is much faster to use Python. Therefore, this function
currently requires Python to be installed on your system and
specifically <code>arcpy</code> with the Spatial Analyst extension. The
R package <code>reticulate</code> will be used internally to run a
simple python script for generating focal statistics. To ensure the
<code>arcpy</code> module can be found, you may need to specify which
version of Python to use. For example (change the filepath as needed to
reflect your system):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/use_python.html" class="external-link">use_python</a></span><span class="op">(</span><span class="st">'C:/Python27/ArcGISx6410.8/python.exe'</span>, required <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>In this example, we apply the function <code>SUM</code> to the
rasters generated in the previous step which have a value of
<code>1</code> for every cell where the land cover class is present, so
that the result will represent the total number of cells of each land
cover class within the distance defined by the <code>scale</code>
argument. The riparian landbird models require focal stats summarizing
both landscapes within two different radii: 50m and 2000m. So here we
can use <code>purrr:map2</code> to iterate over all 4 combinations of
landscape and radius. The results are writen to
<code>pathout/SDM/landscape_name/scale</code>.</p>
<p><em>Note that there is no <code>overwrite</code> option for this
function. If the files already exist in
<code>pathout/SDM/landscape_name</code>, it will return an error.
Previous versions should be deleted manually or <code>pathout</code>
changed.</em></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'50'</span>, <span class="st">'2000'</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/python_focal_run.html">python_focal_run</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors/cover'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'riparian'</span>,</span>
<span>             scale <span class="op">=</span> <span class="va">.y</span>,</span>
<span>             fun <span class="op">=</span> <span class="st">'SUM'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_predictors/focal_stats'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>python_focal_finalize:</strong> The third step is to finalize
the results of the focal stats in the previous step to generate
predictors for use with the riparian distribution models. For
<code>SDM = 'riparian'</code>, this will result in converting the
results of the previous step, which provide the total number of cells of
each land cover class, to a proportion of the total number of cells and
appending the <code>scale</code> value to the predictor name as
<code>_50</code> or <code>_2000</code>, as expected by the original
model. As above, we can use <code>purrr:map2</code> to iterate over all
4 combinations of landscape and radius. The results are written to the
directory <code>pathout/landscape_name</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'50'</span>, <span class="st">'2000'</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/python_focal_finalize.html">python_focal_finalize</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors/focal_stats'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'riparian'</span>,</span>
<span>             scale <span class="op">=</span> <span class="va">.y</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_predictors'</span></span>
<span>           <span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="generate-model-predictions">4.1.2 Generate model predictions<a class="anchor" aria-label="anchor" href="#generate-model-predictions"></a>
</h4>
<p><strong>fit_SDM:</strong> Use the finalized predictors created in the
previous step for each landscape to fit the distribution models for each
of the 9 riparian landbird species. The <code>modlist</code> should
refer to an R object containing a list of the riparian distribution
models.</p>
<p>The original models included <code>area.ha</code>, a predictor
accounting for variation in survey effort, which should be held constant
for new predictions; we selected 3.14159 referring to the total area in
hectares within 50m of a survey location, after 4 surveys. In addition,
the original models included <code>region</code>, a predictor indicating
whether the survey was conducted in the Sacramento Valley (region = 0)
or in the Delta or San Joaquin (region = 1). Thus, all predictions for
the Delta should have a constant value of 1. These constant values can
be passed in as a dataframe, rather than needing to create raster layers
for them, as we did for the other predictors. In addition, in the
original analysis we considered open water to be an unsuitable land
cover class for riparian landbirds <em>a priori</em>, and so we
specified <code>unsuitable = 90</code> (the land cover class value for
open water); this will create a mask from the provided
<code>landscape</code> with 0 values wherever the land cover class
equals the values provided in <code>unsuitable</code> and NA elsewhere,
used to cover the predicted values from the model. Thus, the original
call to this function in our analyses for the Delta looked like
this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_SDM.html">fit_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'riparian'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">BRT_riparian</span>,</span>
<span>             constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>region <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                    area.ha <span class="op">=</span> <span class="fl">3.141593</span><span class="op">)</span>,</span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             unsuitable <span class="op">=</span> <span class="fl">90</span>, <span class="co">#open water</span></span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>However, this code will not work correctly on our example landscapes
for two reasons: (1) the unsuitable land cover class value of 90 does
not exist in our example scenario, and so will result in a mask
landscape of all NA values, throwing an error, and (2) our example
scenario does not include ALL of the predictors required in the original
distribution model, including all land cover classes, climate variables,
and distance to stream.</p>
<p>To predict riparian landbird distributions for our example
landscapes, all required predictors must be provided, either as
additional raster files in the <code>pathin</code> directory or as
constant values. For demonstration purposes only (<em>this approach is
not appropriate for real analyses</em>), we will treat the missing land
cover classes as truly absent from the landscape, with a value of 0 for
every pixel and assume the climate and distance to stream does not vary
across our example landscape. We will also refrain from specifying any
of these land covers as unsuitable <em>a priori</em>.</p>
<p><em>Note: Any predictor provided as a constant will take precedence
over any predictor provided as a raster in the <code>pathin</code>
directory.</em></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_SDM.html">fit_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'riparian'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results'</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">BRT_riparian</span>,</span>
<span>             constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>region <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                    area.ha <span class="op">=</span> <span class="fl">3.141593</span>,</span>
<span>                                    streamdist <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                    bio_1 <span class="op">=</span> <span class="fl">15.5</span>,</span>
<span>                                    bio_12 <span class="op">=</span> <span class="fl">400</span>,</span>
<span>                                    SALIX_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    MIXEDFOREST_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    SALIXSHRUB_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    MIXEDSHRUB_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    INTROSCRUB_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    WATER_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    URBAN_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    IDLE_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    RICE_50 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    SALIX_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    MIXEDFOREST_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    SALIXSHRUB_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    MIXEDSHRUB_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    INTROSCRUB_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    WATER_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    IDLE_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    URBAN_2000 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    RICE_2000 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>transform_SDM:</strong> Finally, because the riparian
landbird species varied in their prevalence across the landscape and in
the precision of the distribution models, different thresholds in their
predicted probability of presence are useful for separating locations
where they are most likely to be present or absent. Therefore, to
estimate the total area of suitable habitat for each species, and for
riparian landbirds collectively, it is useful to convert the continuous
probabilities of species presence predicted in the previous step to
binary predictions of presence or absence. This function passes
detection data embedded in the original models to the
<code><a href="https://rdrr.io/pkg/dismo/man/threshold.html" class="external-link">dismo::threshold</a></code> function to identify values for the
predicted probability of presence that meet the criteria specified.
Here, we use the statistic <code>equal_sens_spec</code>, which is the
value at which specificity (the probability of correctly predicting
species absence) is equal to sensitivity (the probability of correctly
predicting species presence), but other statistics can be selected (see
<code><a href="https://rdrr.io/pkg/dismo/man/threshold.html" class="external-link">?dismo::threshold</a></code>).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/transform_SDM.html">transform_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_results'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'riparian'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">BRT_riparian</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>             stat <span class="op">=</span> <span class="st">'equal_sens_spec'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results_threshold'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="waterbird-models">4.2 Waterbird models<a class="anchor" aria-label="anchor" href="#waterbird-models"></a>
</h3>
<p>The process for fitting waterbird distribution models to each
landscape is similar to the process for riparian landbirds, but requires
a few extra steps to generate updated landscape data that are required.
In addition, there are two separate sets of distribution models for
waterbird groups during the fall (July - mid-Nov) and winter (mid-Nov -
Mar) seasons, which were developed in recognition of the seasonal
changes in species abundance as well as seasonal changes in specific
crop classes in areas where there is a distinct winter crop. Therefore,
in the original analysis, we developed winter versions of the baseline
and scenario landscapes for evaluation. However, for demonstration
purposes, we have only generated one example scenario landscape.</p>
<div class="section level4">
<h4 id="generate-updated-landscape-data">4.2.1 Generate updated landscape data<a class="anchor" aria-label="anchor" href="#generate-updated-landscape-data"></a>
</h4>
<p>The waterbird distribution models require generating focal statistics
representing the landscape, similar to the riparian landbird
distribution models, but they also require inputs representing
<code>covertype</code> (a categorical predictor for the land cover class
in each cell), <code>pwater</code> (the probability of open water in
each cell), and <code>droost</code> (distance to traditional nighttime
crane roosts), all of which may be affected by each landscape scenario
and must also be updated for each landscape to be evaluated. In
particular, <code>pwater</code> must be updated prior to generating
focal statistics in the next step below.</p>
<p><strong>update_covertype:</strong> Covertype is a categorical
predictor reflecting the land cover class in each pixel. Due to the
original study design, only a subset of land cover classes were selected
for survey in each season and are thus included in predictions for
future landscapes: managed wetlands, rice, alfalfa, and irrigated
pasture in both seasons, as well as corn and winter wheat during the
winter season. Because the options are different in each season, we run
this function twice, specifying the intended SDM; all other cover types
will be encoded as NA. The result is a raster layer
<code>covertype.tif</code> ready to use in the distribution models, and
therefore <code>pathout</code> should also be the intended directory for
the eventual output of <code>python_focal_finalize</code> below.</p>
<p><em>Note: Our example landscapes do not include all of these surveyed
land cover classes, so the result of this code will only include values
for Alfalfa and Wetland.</em></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/update_covertype.html">update_covertype</a></span><span class="op">(</span></span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             key <span class="op">=</span> <span class="va">key</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/update_covertype.html">update_covertype</a></span><span class="op">(</span></span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             key <span class="op">=</span> <span class="va">key</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_win'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>update_pwater:</strong> The waterbird distribution models
also included <code>pwater</code> indicating the proportion of the
original survey area that was flooded. For prediction purposes, we used
information about the observed probability of surface water being
present in each cell, during each season over several years. This
surface water data was derived from Point Blue’s Water Tracker, which
analyzes remote sensing data to detect surface water. However, in a
scenario of future landscape change, such as conversion of a grassland
to a managed wetland, we would expect the probability of surface water
to also change. Therefore, if both a baseline and scenario landscape are
provided, this function will analyze the provided <code>pwater</code>
raster by the baseline land cover class to identify the average
probability of surface water, and then for the scenario, assigns the
expected probability of surface water to any cells that have changed
land cover class. If only one landscape is provided, The original
baseline <code>pwater</code> raster layers for the Delta are available
to download from Zenodo doi: <a href="https://doi.org" class="external-link">link TBD</a>.
Here, we randomly generate an example baseline <code>pwater</code> and
then use the function to create an updated <code>pwater</code> layer for
our example scenario.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwater_base_fall</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">$</span><span class="va">baseline</span>,</span>
<span>                   vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">$</span><span class="va">baseline</span><span class="op">)</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># here the first iteration is NULL for the scenario_landscape parameter, so the</span></span>
<span><span class="co"># function will simply copy the baseline version of pwater to the appropriate </span></span>
<span><span class="co"># pathout directory; the second iteration will produce updated assumptions of </span></span>
<span><span class="co"># pwater for the future scenario</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scenario_landscape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">scenario_example</span><span class="op">)</span>,</span>
<span>       landscape_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'baseline'</span>, <span class="st">'scenario_example'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="va"><a href="../reference/update_pwater.html">update_pwater</a></span>,</span>
<span>  waterdat <span class="op">=</span> <span class="va">pwater_base_fall</span>,</span>
<span>  pathout <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>  SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseline_landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">$</span><span class="va">baseline</span>,</span>
<span>  floor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># repeat for winter, assuming pwater values vary seasonally</span></span>
<span><span class="va">pwater_base_win</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">$</span><span class="va">baseline</span>,</span>
<span>                       vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">$</span><span class="va">baseline</span><span class="op">)</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># --&gt; Note: if we had different version of the landscape rasters for the winter </span></span>
<span><span class="co"># season, we would also use those here. In this example, we assume land covers </span></span>
<span><span class="co"># do not change seasonally.</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scenario_landscape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">landscapes</span><span class="op">$</span><span class="va">scenario_example</span><span class="op">)</span>,</span>
<span>       landscape_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'baseline'</span>, <span class="st">'scenario_example'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="va"><a href="../reference/update_pwater.html">update_pwater</a></span>,</span>
<span>  waterdat <span class="op">=</span> <span class="va">pwater_base_win</span>,</span>
<span>  pathout <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>  SDM <span class="op">=</span> <span class="st">'waterbird_win'</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseline_landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">$</span><span class="va">baseline</span>,</span>
<span>  floor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><strong>update_roosts &amp; python_dist:</strong> In addition to
changes in the probability of open water on the landscape, land cover
changes may also affect the suitability of traditional night-time crane
roosts. Because the distance to roost was an important predictor on the
distribution models for cranes, accounting for the loss of traditional
roost locations would affect these distances. The original data source
for traditional roost locations is included in this package, but could
be combined with updated information as it becomes available. The
<code>update_roosts</code> function allows defining which land cover
class codes are incompatible with crane roosts, and the threshold
proportion of the traditional crane roost polygon at which the entire
roost would be considered unsuitable. In our original analyses, we
considered crane roosts to be incompatible with perennial crops, urban
land cover, riparian vegetation, woodland, or scrub, and we assumed once
20% of the roost was covered by unsuitable land covers, the roost
location would be abandoned. The result of <code>update_roosts</code> is
an intermediate file at representing the new assumed locations of
traditional roosts, which is then used as an input to
<code>python_dist</code> for use in updating the estimated distance to
roost predictor for each pixel in the landscape.</p>
<p><em>Note: The land cover types we have designated as “unsuitable” for
use as a crane roost are not expected to vary seasonally, and so we do
not need to create separate versions corresponding to fall and winter
waterbird SDMs.</em></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">roosts_original</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/update_roosts.html">update_roosts</a></span><span class="op">(</span></span>
<span>  landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">$</span><span class="va">scenario_example</span>,</span>
<span>  landscape_name <span class="op">=</span> <span class="st">'scenario_example'</span>,</span>
<span>  unsuitable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">11</span><span class="op">:</span><span class="fl">19</span>, <span class="fl">60</span>, <span class="fl">70</span><span class="op">:</span><span class="fl">79</span>, <span class="fl">100</span><span class="op">:</span><span class="fl">120</span><span class="op">)</span>,</span>
<span>  proportion <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  roosts <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">roosts_original</span><span class="op">)</span>,</span>
<span>  pathout <span class="op">=</span> <span class="st">'SDM_predictors/crane_roosts'</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/python_dist.html">python_dist</a></span><span class="op">(</span></span>
<span>  pathin <span class="op">=</span> <span class="st">'SDM_predictors/crane_roosts'</span>,</span>
<span>  landscape_name <span class="op">=</span> <span class="st">'scenario_example'</span>,</span>
<span>  pathout <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>  SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>  filename <span class="op">=</span> <span class="st">'droost_km.tif'</span>,</span>
<span>  scale <span class="op">=</span> <span class="st">'km'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="prepare-landscape-predictors-1">4.2.2 Prepare landscape predictors<a class="anchor" aria-label="anchor" href="#prepare-landscape-predictors-1"></a>
</h4>
<p>Once the previous steps are completed, especially the update to
<code>pwater</code>, the same steps used for the riparian landbirds are
used to generate focal statistics, but also including focal statistics
based on <code>pwater</code>.</p>
<p><strong>python_focal_prep:</strong> Prepare the land cover rasters as
for riparian landbirds, splitting land cover classes into separate
layers and aggregating as needed for the waterbird models. This time,
cells where each land cover class is present will be filled with a value
corresponding to the area of each pixel, and each land cover layer will
also be used as a mask for the corresponding updated <code>pwater</code>
data, resulting in a second layer for each land cover class filled with
values corresponding to their probability of being flooded. Thus, two
layers are created for each land cover class, and we provide two custom
<code>suffix</code> values to distinguish them when the files are
written to <code>pathout/SDM/landscape_name</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># waterbird_fall</span></span>
<span><span class="va">pwater_fall</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">'SDM_predictors/waterbird_fall'</span>, <span class="st">'pwater.tif$'</span>, </span>
<span>                         full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#pwater names should match landscape names</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pwater_fall</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/python_focal_prep.html">python_focal_prep</a></span><span class="op">(</span></span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>             mask <span class="op">=</span> <span class="va">pwater_fall</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             pixel_value <span class="op">=</span> <span class="fl">0.09</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_predictors/cover'</span>,</span>
<span>             suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'_area'</span>, <span class="st">'_pfld'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># waterbird_win</span></span>
<span><span class="va">pwater_win</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">'SDM_predictors/waterbird_win'</span>, <span class="st">'pwater.tif$'</span>, </span>
<span>                        full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#pwater names should match landscape names</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pwater_win</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/python_focal_prep.html">python_focal_prep</a></span><span class="op">(</span></span>
<span>             landscape <span class="op">=</span> <span class="va">scenarios</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_win'</span>,</span>
<span>             mask <span class="op">=</span> <span class="va">pwater_win</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             pixel_value <span class="op">=</span> <span class="fl">0.09</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_predictors/cover'</span>,</span>
<span>             suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'_area'</span>, <span class="st">'_pfld'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>python_focal_run:</strong> The next step proceeds as for the
riparian landbirds above, generating focal statistics for each of the
separate land cover rasters generated in the previous step. However,
waterbird models require focal statistics on three different scales:
2000, 5000, and 10000 (although waterbird_win models do not require the
2000 scale), and they require separate processing of the
<code>_area</code> layers (with <code>fun = 'SUM'</code>) and
<code>_pfld</code> layers (with <code>fun = 'MEAN'</code>). Here we use
<code><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">purrr::pmap()</a></code> to iterate over all combinations of
landscape, SDM, and spatial scale, and we use the optional
<code>regex</code> parameter to specify the subset to process in each
batch.</p>
<p><em>Note again that there is no <code>overwrite</code> option for
this function. If the files already exist in
<code>pathout/SDM/landscape_name</code>, it will return an error.
Previous versions should be deleted manually or <code>pathout</code>
changed.</em></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combos</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span>SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>              landscape_name <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span>,</span>
<span>              scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'2000'</span>, <span class="st">'5000'</span>, <span class="st">'10000'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span>SDM <span class="op">=</span> <span class="st">'waterbird_win'</span>,</span>
<span>              landscape_name <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span>,</span>
<span>              scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'5000'</span>, <span class="st">'10000'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># total area of each land cover class for each spatial scale, SDM, and landscape</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">combos</span>,</span>
<span>            <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="va"><a href="../reference/python_focal_run.html">python_focal_run</a></span>,</span>
<span>            pathin <span class="op">=</span> <span class="st">'SDM_predictors/cover'</span>,</span>
<span>            pathout <span class="op">=</span> <span class="st">'SDM_predictors/focal_stats'</span>,</span>
<span>            regex <span class="op">=</span> <span class="st">'*_area.tif'</span>, fun <span class="op">=</span> <span class="st">'SUM'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mean pfld for each land cover class for each spatial scale, SDM, and landscape</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">combos</span>,</span>
<span>            <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="va"><a href="../reference/python_focal_run.html">python_focal_run</a></span>,</span>
<span>            pathin <span class="op">=</span> <span class="st">'SDM_predictors/cover'</span>,</span>
<span>            pathout <span class="op">=</span> <span class="st">'SDM_predictors/focal_stats'</span>,</span>
<span>            regex <span class="op">=</span> <span class="st">'*_pfld.tif'</span>, fun <span class="op">=</span> <span class="st">'MEAN'</span><span class="op">)</span></span></code></pre></div>
<p><strong>python_focal_finalize:</strong> Next, finalize the results of
the focal stats in the previous step to generate predictors for use with
the waterbird distribution models. For
<code>SDM = 'waterbird_fall'</code> or
<code>SDM = 'waterbird_win'</code>, this will result in appending the
<code>scale</code> to the predictor name in the format “_2k”, “_5k”, or
“_10k”, as expected by the original models. The results are written to
the directory <code>pathout/SDM/landscape_name</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">pmap</span>(combos,</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>            DeltaMultipleBenefits<span class="sc">::</span>python_focal_finalize,</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>            <span class="at">pathin =</span> <span class="st">'SDM_predictors/focal_stats'</span>,</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>            <span class="at">pathout =</span> <span class="st">'SDM_predictors'</span>,</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>            <span class="at">cover =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)<span class="er">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="generate-model-predictions-1">4.2.3 Generate model predictions<a class="anchor" aria-label="anchor" href="#generate-model-predictions-1"></a>
</h4>
<p><strong>fit_SDM:</strong> Use the finalized predictors created in the
previous step for each landscape to fit the distribution models for each
of the 5 fall and 6 winter waterbird groups. Again, the
<code>modlist</code> should refer to an R object containing a list of
the fall or winter waterbird distribution models.</p>
<p>Similar to the riparian models, the waterbird models included
<code>offset</code>, a predictor accounting for variation in survey
effort, with different values appiled to the predictions for waterbird
groups in fall vs. winter, as well as a separate value for cranes and
geese during the fall (which had a more restricted fall season). In
addition, the <code>covertype</code> of the area within which the survey
was conducted was treated as a factor variable, which must be specified,
and the available factor levels varied between the fall and winter
seasons. In the original analysis, we also considered perennial crops,
urban, and barren land covers to be an unsuitable waterbirds <em>a
priori</em>, and so we specified
<code>unsuitable = c(10:19, 60, 130)</code> (the corresponding land
cover class values); this will create a mask from the provided
<code>landscape</code> with 0 values wherever the land cover class
equals the values provided in <code>unsuitable</code> and NA elsewhere,
used to cover the predicted values from the model. Thus, due to the
distinct values for <code>offset</code>, we call <code>fit_SDM</code>
three times:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fall: cranes, geese</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_SDM.html">fit_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">waterbird_mods_fall</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'crane'</span>, <span class="st">'geese'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>             constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>offset <span class="op">=</span> <span class="fl">3.709</span><span class="op">)</span>,</span>
<span>             factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'covertype'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Alfalfa'</span>,</span>
<span>                                                 <span class="st">'Irrigated pasture'</span>,</span>
<span>                                                 <span class="st">'Rice'</span>,</span>
<span>                                                 <span class="st">'Wetland'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             unsuitable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">19</span>, <span class="fl">60</span>, <span class="fl">130</span><span class="op">)</span>, </span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fall: dblr, shore, cicon:</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_SDM.html">fit_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">waterbird_mods_fall</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dblr'</span>, <span class="st">'cicon'</span>, <span class="st">'shore'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>             constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>offset <span class="op">=</span> <span class="fl">4.435</span><span class="op">)</span>,</span>
<span>             factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'covertype'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Alfalfa'</span>,</span>
<span>                                                 <span class="st">'Irrigated pasture'</span>,</span>
<span>                                                 <span class="st">'Rice'</span>,</span>
<span>                                                 <span class="st">'Wetland'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             unsuitable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">19</span>, <span class="fl">60</span>, <span class="fl">130</span><span class="op">)</span>, </span>
<span>             landscape <span class="op">=</span> <span class="va">landscapes</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># winter: all</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_SDM.html">fit_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_predictors'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_win'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">waterbird_mods_win</span>,</span>
<span>             constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>offset <span class="op">=</span> <span class="fl">3.617</span><span class="op">)</span>,</span>
<span>             factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'covertype'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Alfalfa'</span>,</span>
<span>                                                 <span class="st">'Corn'</span>,</span>
<span>                                                 <span class="st">'Irrigated pasture'</span>,</span>
<span>                                                 <span class="st">'Rice'</span>,</span>
<span>                                                 <span class="st">'Wetland'</span>,</span>
<span>                                                 <span class="st">'Winter wheat'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             unsuitable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">19</span>, <span class="fl">60</span>, <span class="fl">130</span><span class="op">)</span>, <span class="co">#perennial crops, urban, barren</span></span>
<span>             landscape <span class="op">=</span> <span class="va">scenarios</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results'</span>,</span>
<span>             overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>transform_SDM:</strong> Again, as with riparian landbirds,
convert the continuous probabilities of waterbird group presence
predicted in the previous step to binary predictions of presence or
absence.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/transform_SDM.html">transform_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_results'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_fall'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">BRT_riparian</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>             stat <span class="op">=</span> <span class="st">'equal_sens_spec'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results_threshold'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landscapes</span><span class="op">)</span>,</span>
<span>           <span class="op">~</span><span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/transform_SDM.html">transform_SDM</a></span><span class="op">(</span></span>
<span>             pathin <span class="op">=</span> <span class="st">'SDM_results'</span>,</span>
<span>             SDM <span class="op">=</span> <span class="st">'waterbird_win'</span>,</span>
<span>             landscape_name <span class="op">=</span> <span class="va">.x</span>,</span>
<span>             modlist <span class="op">=</span> <span class="va">BRT_riparian</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>             stat <span class="op">=</span> <span class="st">'equal_sens_spec'</span>,</span>
<span>             pathout <span class="op">=</span> <span class="st">'SDM_results_threshold'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="estimate-the-net-change-in-bird-habitat">4.3 Estimate the net change in bird habitat<a class="anchor" aria-label="anchor" href="#estimate-the-net-change-in-bird-habitat"></a>
</h3>
<p>At this stage, the steps for estimating the net change in the total
amount of habitat provided by each scenario for riparian landbirds and
waterbird groups is similar to estimating the net change in the area of
each land cover class and in each of the “simple metrics” above.</p>
<p><strong>sum_habitat:</strong> Estimate the total area of each
landscape each species is predicted to occupy. This function is similar
to <code>sum_landcover</code>, but with a few key differences. By
default, all prediction rasters in the <code>pathin</code> argument and
any subdirectories will be included, so it can handle the results from
multiple scenarios and multiple sets of distribution models
simultaneously. However, <code>SDM</code> or both <code>SDM</code> and
<code>landscape_name</code> can optionally be specified to limit the
predictions evaluated. In addition, by including the option
<code>rollup = TRUE</code>, the total area occupied by at least one
species in the set will also be calculated.</p>
<p>By default, the result is the total count of pixels with a predicted
species presence, but the count can be optionally multiplied by the area
of each pixel by providing a <code>pixel_area</code> value in the
desired units. Here we also added a <code>mutate</code> argument to the
results to clearly specify the units used. Either way, the results are
structured to align with the results of <code><a href="../reference/sum_metrics.html">sum_metrics()</a></code> used
above for summarizing the total landscapes scores for the simple
metrics, so that the habitat totals can be appended to those results,
and the net change can be estimated simultaneously.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">habitat_totals</span> <span class="op">=</span> <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/sum_habitat.html">sum_habitat</a></span><span class="op">(</span></span>
<span>  pathin <span class="op">=</span> <span class="st">'SDM_results_threshold'</span>,</span>
<span>  rollup <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pixel_area <span class="op">=</span> <span class="fl">0.09</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>UNIT <span class="op">=</span> <span class="st">'ha'</span><span class="op">)</span></span></code></pre></div>
<p><strong>sum_change:</strong> Again, use this function to estimate the
net change in the total area of the landscape each species is predicted
to occupy, as an indication of the net change in the total area of
suitable habitat for each species. Optionally
<code>habitat_totals</code> can first be appended to <code>scores</code>
above (the result of <code><a href="../reference/sum_metrics.html">sum_metrics()</a></code>) to calculate the net
change across all benefits categories simultaneously and include
biodiversity support in the visualization of the results alongside the
other categories of benefits.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scores_change_habitat</span> <span class="op">=</span> <span class="fu">DeltaMultipleBenefits</span><span class="fu">::</span><span class="fu"><a href="../reference/sum_change.html">sum_change</a></span><span class="op">(</span><span class="va">habitat_totals</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="supporting-data">Supporting Data<a class="anchor" aria-label="anchor" href="#supporting-data"></a>
</h2>
<ul>
<li><p>Baseline and scenario rasters: Dybala KE. 2023. Baseline and
projected future land use and land cover in the Sacramento-San Joaquin
Delta. Available from: <a href="https://wildlife.ca.gov/Data/BIOS" class="external-link uri">https://wildlife.ca.gov/Data/BIOS</a></p></li>
<li><p>Metrics (also included in the <em>DeltaMultipleBenefits</em>
package): Dybala KE. 2023. Multiple-benefit Conservation in Practice:
Metrics Data for Quantifying Multidimensional Impacts of Landscape
Change in California’s Sacramento–San Joaquin Delta. doi: <a href="https://doi.org/10.5281/zenodo.7504874" class="external-link">10.5281/zenodo.7504874</a>.</p></li>
<li><p>Species distribution models: Dybala KE, Sesser KA, Reiter ME,
Shuford WD, Golet GH, Hickey CM, Gardali T. 2023. Distribution models
for riparian landbirds and waterbirds in the Sacramento-San Joaquin
Delta. doi: <a href="https://doi.org/10.5281/zenodo.7531945" class="external-link">10.5281/zenodo.7531945</a>.</p></li>
<li><p>Supplemental spatial data: Dybala KE. 2023. Multiple-benefit
Conservation in Practice: Supplemental Spatial Data for Quantifying
Multidimensional Impacts of Landscape Change in California’s
Sacramento–San Joaquin Delta. doi: <a href="https://doi.org/10.5281/zenodo.7672193" class="external-link">10.5281/zenodo.7672193</a>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="relevant-literature">Relevant Literature<a class="anchor" aria-label="anchor" href="#relevant-literature"></a>
</h2>
<p>Dybala K, Sesser K, Reiter M, Shuford WD, Golet GH, Hickey C, Gardali
T (2023) Priority Bird Conservation Areas in California’s Sacramento–San
Joaquin Delta. San Francisco Estuary and Watershed Science 21(3). DOI:
<a href="https://doi.org/10.15447/sfews.2023v21iss3art4" class="external-link">10.15447/sfews.2023v21iss3art4</a><br><a href="https://www.kristendybala.com/files/Dybala2023_PriorityBirdConservationAreas.pdf" target="_blank" class="external-link"><img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/svgs/solid/file-pdf.svg" width="20" height="20"></a></p>
<p>Dybala KE, Reiter ME, Hickey CM (<em>In press</em>) Multiple-benefit
Conservation in Practice: A Framework for Quantifying Multi-dimensional
Impacts of Landscape Change in California’s Sacramento–San Joaquin
Delta. San Francisco Estuary and Watershed Science.</p>
<p>Dybala KE, Sesser K, Reiter M, Hickey C, Gardali T (2023) <em>Final
Project Report: Trade-offs and Co-benefits of Landscape Change Scenarios
on Bird Communities and Ecosystem Services in the Sacramento-San Joaquin
River Delta.</em> Point Blue Conservation Science, Petaluma, CA<br><a href="https://www.kristendybala.com/files/Dybala2023_DeltaMultipleBenefits_Report.pdf" target="_blank" class="external-link"><img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/svgs/solid/file-pdf.svg" width="20" height="20"></a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kristen Dybala.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
